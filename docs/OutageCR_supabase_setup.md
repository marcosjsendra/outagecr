# Supabase Setup Guide for OutageCR

This document outlines the steps required to set up the Supabase project for the ¿Hay Luz? (OutageCR) application. Please follow these instructions and provide the necessary credentials to populate the local `.env` file.

---

## 1. Create a Supabase Project

If you haven't already, create a new project on the [Supabase dashboard](https://app.supabase.com/).

1. **Sign Up / Log In**: Use your GitHub account or email to sign up or log in.
2. **New Project**: Click on "New Project".
3. **Organization**: Select an existing organization or create a new one (e.g., "OutageCR" or your personal org).
4. **Project Details**:
    * **Name**: Give your project a memorable name (e.g., `outagecr-app`, `hay-luz-db`).
    * **Database Password**: Create a strong password for the database. **Save this password securely**, as it will be needed if you ever need to connect directly to the database.
    * **Region**: Choose a region geographically close to your target users (Costa Rica). `us-east-1` (North Virginia) or `southamerica-east1` (São Paulo) are often good choices for Central American users. Consider latency.
    * **Pricing Plan**: For the MVP, the **Free Tier** is sufficient.
5. **Create Project**: Click "Create new project". Wait for Supabase to provision your project (this usually takes a couple of minutes).

---

## 2. Retrieve Project Credentials

Once your project is created, you'll be taken to the project's dashboard. You need to find the API credentials.

1. Navigate to **Settings** > **API** in the left-hand sidebar of your Supabase project dashboard.
2. You will find two key pieces of information under the "Project API keys" section:
    * **Project URL**: This is the unique URL for your Supabase instance.
    * `anon` **public** **key**: This is the safe-to-use public key for client-side applications.

**Action Required:**
Copy the **Project URL** and the `anon` **public** key and paste them into the corresponding placeholders in your local `.env` file:

```dotenv
# .env file

# Your Supabase project URL
NEXT_PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co

# Your Supabase anonymous public key
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## 3. Database Schema Design

We need to define the tables for storing outage reports. Based on the PRD, here's a proposed initial schema. You can create these tables using the Supabase SQL Editor (**SQL Editor** > **New query**).

### 3.1 `outages` Table

This table will store each individual outage report.

```sql
-- SQL to create the 'outages' table
CREATE TABLE public.outages (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,

    -- Location Information
    -- Using a point type for geospatial queries. Requires PostGIS extension.
    location geography(POINT, 4326) NOT NULL,
    address_text text, -- Optional: User-provided address or description of location

    -- Outage Details
    outage_type text NOT NULL, -- 'electricity' or 'water'
    status text NOT NULL DEFAULT 'active', -- 'active', 'resolved'
    description text,

    -- Reporter Information (Anonymous)
    reporter_ip inet, -- Store IP for spam moderation, consider privacy implications
    user_agent text, -- Optional: Store user agent for analytics/moderation

    -- Moderation & Validation
    upvotes integer DEFAULT 0,
    downvotes integer DEFAULT 0,
    is_verified boolean DEFAULT false, -- Can be updated by admin/moderation
    resolved_at timestamp with time zone,

    -- Optional: Photo URL (if we implement photo uploads)
    -- photo_url text
);

-- Add comments for clarity
COMMENT ON TABLE public.outages IS 'Stores crowdsourced reports of electricity and water outages.';
COMMENT ON COLUMN public.outages.location IS 'Geographic location (latitude, longitude) using PostGIS POINT type.';
COMMENT ON COLUMN public.outages.outage_type IS 'Type of outage: electricity or water.';
COMMENT ON COLUMN public.outages.status IS 'Current status of the outage report: active or resolved.';
COMMENT ON COLUMN public.outages.reporter_ip IS 'IP address of the reporter for spam prevention and moderation.';
```

### 3.2 Enable PostGIS Extension

The `location` column uses the `geography` type, which requires the PostGIS extension.

1. Go to **Database** > **Extensions** in your Supabase dashboard.
2. Search for `postgis`.
3. Toggle the switch to enable it.

---

## 4. Row Level Security (RLS)

RLS is crucial for securing your data. We want to allow anyone to insert a new outage report and for anyone to view existing reports, but not allow anonymous users to update or delete reports.

### 4.1 Enable RLS on `outages` Table

1. Go to **Authentication** > **Policies** in the Supabase dashboard.
2. Select the `outages` table.
3. Ensure "Enable RLS" is toggled on.

### 4.2 Create Policies

You can create these policies using the Supabase dashboard UI or by running SQL queries in the **SQL Editor**.

#### Policy 1: Allow Anonymous Inserts

This allows any user (even unauthenticated ones) to create a new outage report.

```sql
-- Policy to allow anyone to insert into the outages table
CREATE POLICY "Allow anonymous inserts" ON public.outages
FOR INSERT WITH CHECK (true);
```

#### Policy 2: Allow Public Select (Read Access)

This allows anyone to view all outage reports.

```sql
-- Policy to allow anyone to select from the outages table
CREATE POLICY "Enable read access for all users" ON public.outages
FOR SELECT USING (true);
```

#### Policy 3: Restrict Updates and Deletes (Optional but Recommended)

For now, we might want to restrict updates and deletes entirely, or only allow them via a service role key (for admin functions). If you don't create any `UPDATE` or `DELETE` policies, then by default, no one (including anonymous users) can perform these actions, which is a safe starting point.

If you need an admin to be able to update/delete, you would create a policy that checks for a specific role or uses the service role key.

---

## 5. Next Steps for Development

Once the Supabase project is set up and the `.env` file is populated:

1. **Install Supabase Client**: In the frontend project (once initialized), install the Supabase JavaScript client library:

    ```bash
    npm install @supabase/supabase-js
    ```

2. **Initialize Supabase Client**: Create a utility file (e.g., `lib/supabaseClient.js`) to initialize the Supabase client using the environment variables.
3. **Implement API Calls**: Use the initialized client to perform CRUD operations:
    * `select()` to fetch outages for the map/list view.
    * `insert()` to submit new outage reports from the form.
    * `update()` to change the status of an outage (e.g., to 'resolved') - this might be done via an admin function later.

---

## Checklist for Supabase Setup

* [ ] Create a new Supabase project.
* [ ] Retrieve Project URL and `anon` key.
* [ ] Populate the local `.env` file with the credentials.
* [ ] Enable the `postgis` extension in the database.
* [ ] Create the `outages` table with the defined schema.
* [ ] Enable Row Level Security (RLS) on the `outages` table.
* [ ] Create the "Allow anonymous inserts" policy.
* [ ] Create the "Enable read access for all users" policy.
* [ ] (Optional) Define policies for `UPDATE` and `DELETE` operations.
* [ ] Commit the `.gitignore` file to the repository (but not the `.env` file!).
